CREATE SCHEMA BOOK_DEALER;

USE BOOK_DEALER;

CREATE TABLE AUTHOR
(
AUID INT PRIMARY KEY,
NAME VARCHAR(15) NOT NULL,
CITY VARCHAR(15) NOT NULL,
COUNTRY VARCHAR(15) NOT NULL
);

CREATE TABLE PUBLISHER
(
PUID INT PRIMARY KEY,
NAME VARCHAR(15) NOT NULL,
CITY VARCHAR(15) NOT NULL,
COUNTRY VARCHAR(15) NOT NULL
);

CREATE TABLE CATEGORY
(
CID INT PRIMARY KEY,
DESCRIPTION VARCHAR(15) NOT NULL
);

CREATE TABLE CATALOG
(
BID INT PRIMARY KEY,
TITLE VARCHAR(15) NOT NULL,
AUID INT NOT NULL,
PUID INT NOT NULL,
CID INT NOT NULL,
YEAR INT NOT NULL,
PRICE INT NOT NULL,
FOREIGN KEY(AUID) REFERENCES AUTHOR(AUID) ON DELETE CASCADE,
FOREIGN KEY(PUID) REFERENCES PUBLISHER(PUID) ON DELETE CASCADE,
FOREIGN KEY(CID) REFERENCES CATEGORY(CID) ON DELETE CASCADE
);

CREATE TABLE ODETAILS
(
ONO INT,
BID INT,
QTY INT CHECK (QTY>0),
PRIMARY KEY(ONO,BID),
FOREIGN KEY(BID) REFERENCES CATALOG(BID) ON DELETE CASCADE
);


INSERT INTO AUTHOR VALUES (1,'MIK','BANG','IND');
INSERT INTO AUTHOR VALUES (2,'MUJ','BANG','IND');
INSERT INTO AUTHOR VALUES (3,'PRAD','TRI','AUS');
INSERT INTO AUTHOR VALUES (4,'MAJ','ANAN','AME');
INSERT INTO AUTHOR VALUES (5,'WAJ','ANAN','EURO');

INSERT INTO PUBLISHER VALUES (101,'PEARSON','BANG','IND');
INSERT INTO PUBLISHER VALUES (102,'TATA','MUMBAI','AUS');
INSERT INTO PUBLISHER VALUES (103,'SAPNA','CHE','EURO');
INSERT INTO PUBLISHER VALUES (104,'ABC','TRI','AME');
INSERT INTO PUBLISHER VALUES (105,'XYZ','ANAN','IND');

INSERT INTO CATEGORY VALUES (1001,'COMPUTER');
INSERT INTO CATEGORY VALUES (1002,'ELECTRONICS');
INSERT INTO CATEGORY VALUES (1003,'MATHS');
INSERT INTO CATEGORY VALUES (1004,'SCIENCE');
INSERT INTO CATEGORY VALUES (1005,'ELECTRICAL');

INSERT INTO CATALOG VALUES (111,'LIB1',1,101,1001,2002,500);
INSERT INTO CATALOG VALUES (112,'LIB2',2,102,1002,2000,800);
INSERT INTO CATALOG VALUES (119,'LIB9',3,102,1002,2000,473);
INSERT INTO CATALOG VALUES (113,'LIB3',3,103,1003,2003,200);
INSERT INTO CATALOG VALUES (114,'LIB4',4,104,1001,2006,350);
INSERT INTO CATALOG VALUES (115,'LIB5',5,105,1004,2007,100);
INSERT INTO CATALOG VALUES (116,'LIB6',2,103,1005,2007,600);
INSERT INTO CATALOG VALUES (117,'LIB7',2,105,1002,2007,450);
INSERT INTO CATALOG VALUES (118,'LIB8',1,101,1001,2002,500);


INSERT INTO ODETAILS VALUES (1,111,2);
INSERT INTO ODETAILS VALUES (2,112,3);
INSERT INTO ODETAILS VALUES (3,111,5);
INSERT INTO ODETAILS VALUES (4,113,1);
INSERT INTO ODETAILS VALUES (5,114,2);
INSERT INTO ODETAILS VALUES (6,115,1);
INSERT INTO ODETAILS VALUES (1,114,2);
INSERT INTO ODETAILS VALUES (2,113,2);
INSERT INTO ODETAILS VALUES (7,111,3);
INSERT INTO ODETAILS VALUES (7,113,20);

--
SELECT * 
	FROM AUTHOR
	WHERE AUID IN (SELECT AUID 
				FROM CATALOG
				WHERE YEAR > 2000
				AND PRICE > (SELECT AVG(PRICE) FROM CATALOG)
				GROUP BY AUID
				HAVING COUNT(AUID) > 1);

/* QUERY 2 * USING VIEWS */
CREATE VIEW V1 AS SELECT BID, SUM(QTY) AS SQTY FROM ODETAILS GROUP BY BID;

SELECT * FROM V1;

CREATE VIEW V2 AS SELECT V1.BID AS BID,PRICE, PRICE*SQTY AS PSQTY FROM CATALOG C,V1 WHERE V1.BID=C.BID;

SELECT * FROM V2;

SELECT A.AUID,A.NAME FROM AUTHOR A,CATALOG C WHERE A.AUID=C.AUID AND C.BID=(SELECT V2.BID FROM V2 WHERE PSQTY=(SELECT MAX(PSQTY) FROM V2));

-- QUERY 3
UPDATE CATALOG SET PRICE=1.1*PRICE WHERE PUID IN (SELECT PUID FROM PUBLISHER WHERE NAME='ABC'); 
